<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Kalkulator Ilmiah AYIIPP - Expert Mode</title>
    
    <meta name="description" content="Kalkulator ilmiah modern dengan fungsi expert, konversi, geometri, dan pencarian rumus, dilengkapi input suara dan panel kunci.">
    
    <meta name="keywords" content="kalkulator, scientific calculator, kalkulator expert, kalkulator rumus, kalkulator suara, kalkulator konversi">
    
    <meta name="author" content="Ayiipp">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* Variabel CSS untuk Warna dan Ukuran */
        :root {
            --primary-color: #00bcd4; /* Cyan */
            --primary-dark: #0097a7;
            --background-color: #eef1f5; /* Light Gray */
            --card-color: #ffffff;
            --text-color: #333;
            --operator-color: #ff9800; /* Orange */
            --scientific-color: #5c6bc0; /* Indigo */
            --expert-color: #3f51b5; /* Biru Tua untuk Expert */
            --history-bg: #f5f7fa;
            --calc-max-width: 400px;
            --padding-base: 20px; 
            --history-width: 300px;
        }

        /* Reset Box Model */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Styling Tubuh Dokumen */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent; 
        }

        /* Kontainer Utama Kalkulator */
        .main-container {
            position: relative;
            width: 100%;
            max-width: var(--calc-max-width);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 0 10px rgba(0, 0, 0, 0.05);
            border-radius: 25px;
            overflow: hidden;
        }

        /* Padding Kalkulator */
        .calculator {
            background-color: var(--card-color);
            padding: var(--padding-base);
        }

        /* --- Layar Input/Output --- */
        .display-container { 
            text-align: right; 
            margin-bottom: 20px; 
            padding: 10px 5px; 
        }
        .history-current { 
            font-size: 1em; 
            color: #888; 
            min-height: 1.1em; 
            line-height: 1.1em; 
        }

        /* Tampilan Hasil/Input Utama (Auto-Scroll Kanan) */
        .result { 
            font-size: 3.5em; 
            font-weight: 300; 
            color: var(--text-color); 
            overflow-x: scroll; 
            white-space: nowrap; 
            line-height: 1.2; 
            direction: rtl; /* KUNCI 1: Input muncul dari kanan */
            text-align: left; /* KUNCI 2: Memastikan teks tidak terpotong saat scroll */
        }

        .result::first-letter {
            direction: ltr;
        }
        .result:empty, .result:not([style*="font-size: 2em"]):not([style*="font-size: 3.5em"]) {
            direction: ltr; 
            text-align: right;
        }
        
        /* Styling Scrollbar */
        .result::-webkit-scrollbar { height: 6px; }
        .result::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .result::-webkit-scrollbar-track { background: transparent; }


        /* --- Tombol Kalkulator (Grid 4 Kolom) --- */
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(9, 1fr); /* 9 baris untuk expert */
            gap: 10px; 
        }

        .btn {
            padding: 15px 0; 
            font-size: 1.2em;
            border: none;
            border-radius: 10px; 
            cursor: pointer;
            transition: background-color 0.05s, box-shadow 0.05s, transform 0.05s; 
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            min-height: 50px; 
        }

        .btn:active {
            transform: translateY(0.5px); 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); 
            filter: brightness(0.95); 
        }

        /* Penyesuaian Grid untuk BARIS TERAKHIR */
        .buttons button[data-value="0"] { grid-column: 2 / span 2; grid-row: 9; direction: ltr; } 
        .buttons button[data-value="."]{ grid-column: 1; grid-row: 9; direction: ltr;}
        .buttons button[data-value="="] { grid-column: 4; grid-row: 9; direction: ltr;}


        /* GAYA TOMBOL Berdasarkan Kelas */
        .num { background-color: #f0f0f0; color: var(--text-color); } 
        .op, .eq { background-color: var(--operator-color); color: white; font-weight: bold; } 
        .fn { background-color: #e0f7fa; color: var(--primary-dark); font-weight: 600; } 
        .sci { background-color: var(--scientific-color); color: white; font-size: 1em; font-weight: 500; box-shadow: 0 2px 4px rgba(92, 107, 192, 0.4); } 
        .expert { background-color: var(--expert-color); color: white; font-size: 1em; }
        .eq { background-color: var(--primary-color); font-size: 1.6em; } 

        .buttons button[data-value="^2"], .buttons button[data-value="ln("] { font-size: 1em; }
        .buttons button[data-value="!"] { font-size: 1.2em; }


        /* --- Header dan Panel (Riwayat & Kunci) --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 0 5px; }
        .header > div { display: flex; gap: 10px; } /* Kontainer untuk tombol kanan (Key & Mic) */
        
        .burger-menu, .mic-button, .key-button { background: none; border: none; cursor: pointer; color: var(--primary-dark); padding: 5px; z-index: 1001; transition: color 0.2s; }
        .mic-button span.material-icons, .key-button span.material-icons { font-size: 1.6em; }
        .title { color: var(--primary-color); font-size: 1.8em; font-weight: 800; letter-spacing: 2px; margin: 0; }
        
        /* Overlay dan Panel (Riwayat & Kunci) */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .overlay.active { opacity: 1; visibility: visible; }
        
        .panel { position: fixed; top: 0; width: var(--history-width); max-width: 80%; height: 100%; background: var(--history-bg); z-index: 1000; box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1); transition: transform 0.3s; display: flex; flex-direction: column; }
        
        /* Riwayat Panel (Kiri) */
        #historyPanel { left: 0; transform: translateX(-100%); }
        /* Kunci Panel (Kanan) */
        #keyPanel { right: 0; left: auto; transform: translateX(100%); }
        
        .panel.open { transform: translateX(0); }

        .panel-header { padding: var(--padding-base); background-color: var(--card-color); border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { margin: 0; font-size: 1.2em; color: var(--text-color); }
        .panel-header button { background: none; border: none; cursor: pointer; color: #f44336; padding: 5px; }
        .panel-content { padding: var(--padding-base); flex-grow: 1; overflow-y: auto; }
        .history-item, .key-group { padding: 10px; margin-bottom: 10px; background: var(--card-color); border-radius: 8px; cursor: pointer; transition: background 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .history-item:hover { background: #f0f0f0; }
        
        .key-group { cursor: default; } /* Halaman kunci tidak bisa diklik untuk di load */
        .key-group h3 { margin-top: 0; margin-bottom: 5px; color: var(--primary-dark); font-size: 1.1em; }
        .key-group p { margin: 0; font-size: 0.9em; color: #555; line-height: 1.4; }

        /* Responsif (Mobile View) */
        @media (max-width: 550px) {
            body { align-items: flex-start; }
            .main-container { border-radius: 0; box-shadow: none; min-height: 100vh; max-width: none; }
            .calculator { padding: 15px; }
            .buttons { gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div> 
    
    <div class="panel" id="historyPanel">
        <div class="panel-header">
            <h2>Riwayat Perhitungan</h2>
            <button id="clearHistoryBtn" title="Hapus Semua Riwayat">
                <span class="material-icons">delete</span>
            </button>
        </div>
        <div id="historyList" class="panel-content">
            <p class="empty-history">Belum ada perhitungan.</p>
        </div>
    </div>
    
    <div class="panel" id="keyPanel">
        <div class="panel-header">
            <h2>Kunci Perintah Suara üóùÔ∏è</h2>
            <button id="closeKeyPanelBtn" title="Tutup">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div id="keyList" class="panel-content">
            </div>
    </div>

    
    <div class="main-container">
        <div class="calculator">
            
            <div class="header">
                <button class="burger-menu" id="burgerMenu" title="Riwayat">
                    <span class="material-icons">history</span>
                </button>
                <h1 class="title">Ayiipp</h1>
                <div>
                    <button id="keyBtn" class="key-button" title="Daftar Kata Kunci">
                        <span class="material-icons">vpn_key</span>
                    </button>
                    <button id="micBtn" class="mic-button" title="Input Suara">
                        <span class="material-icons">mic</span>
                    </button>
                </div>
            </div>
            
            <div class="display-container">
                <div id="history-current" class="history-current"></div>
                <div id="result" class="result">0</div> 
            </div>
            
            <div class="buttons">
                
                <button class="btn expert" data-value="ln(">ln</button>
                <button class="btn expert" data-value="!">n!</button>
                <button class="btn expert" data-value="perm(" title="Permutasi: n, r">P(n,r)</button>
                <button class="btn expert" data-value="comb(" title="Kombinasi: n, r">C(n,r)</button>

                <button class="btn sci" data-value="sin(">sin</button>
                <button class="btn sci" data-value="cos(">cos</button>
                <button class="btn sci" data-value="tan(">tan</button>
                <button class="btn sci" data-value="^">x ∏</button>

                <button class="btn sci" data-value="log(">log</button>
                <button class="btn sci" data-value="pi">œÄ</button>
                <button class="btn sci" data-value="e">e</button>
                <button class="btn sci" data-value="sqrt(">‚àö</button>

                <button class="btn fn" data-value="clear">C</button>
                <button class="btn fn" data-value="%">%</button>
                <button class="btn fn" data-value="module">MOD</button>
                <button class="btn sci" data-value="^2">x¬≤</button>

                <button class="btn op" data-value="(">(</button>
                <button class="btn op" data-value=")">)</button>
                <button class="btn fn" data-value="backspace"><span class="material-icons">backspace</span></button>
                <button class="btn op" data-value="/">√∑</button>

                <button class="btn num" data-value="7">7</button>
                <button class="btn num" data-value="8">8</button>
                <button class="btn num" data-value="9">9</button>
                <button class="btn op" data-value="*">√ó</button>

                <button class="btn num" data-value="4">4</button>
                <button class="btn num" data-value="5">5</button>
                <button class="btn num" data-value="6">6</button>
                <button class="btn op" data-value="-">-</button>

                <button class="btn num" data-value="1">1</button>
                <button class="btn num" data-value="2">2</button>
                <button class="btn num" data-value="3">3</button>
                <button class="btn op" data-value="+">+</button>

                <button class="btn num" data-value=".">.</button>
                <button class="btn num" data-value="0">0</button>
                <button class="btn eq" data-value="=">=</button>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const resultEl = document.getElementById('result');
        const historyCurrentEl = document.getElementById('history-current');
        const historyListEl = document.getElementById('historyList');
        const micBtn = document.getElementById('micBtn');
        const buttons = document.querySelector('.buttons');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const burgerMenuBtn = document.getElementById('burgerMenu');
        const historyPanel = document.getElementById('historyPanel');
        const keyBtn = document.getElementById('keyBtn');
        const keyPanel = document.getElementById('keyPanel');
        const closeKeyPanelBtn = document.getElementById('closeKeyPanelBtn');
        const overlay = document.getElementById('overlay');
        const keyListEl = document.getElementById('keyList');

        // Variabel Status Global
        let currentExpression = '0';
        let lastResult = null;
        let historyRecords = []; 

        // ---------------------------------------------------------------------
        // FUNGSI MATEMATIKA EXPERT
        // ---------------------------------------------------------------------

        function factorial(n) {
            if (n < 0 || n % 1 !== 0) throw new Error("Faktorial hanya untuk bilangan bulat non-negatif.");
            if (n === 0) return 1;
            let res = 1;
            for (let i = 2; i <= n; i++) res *= i;
            return res;
        }

        function permutation(n, r) {
            if (n < r || n < 0 || r < 0) return NaN;
            return factorial(n) / factorial(n - r);
        }

        function combination(n, r) {
            if (n < r || n < 0 || r < 0) return NaN;
            return factorial(n) / (factorial(r) * factorial(n - r));
        }

        // ---------------------------------------------------------------------
        // DATA DUMMY UNTUK KONVERSI DAN RUMUS
        // ---------------------------------------------------------------------
        const currencyRates = {
            usd: 15000, idr: 1, eur: 16000, jpy: 105, aud: 10000 
        };
        function getRate(from, to) {
            const fromRate = currencyRates[from.toLowerCase()] || 1;
            const toRate = currencyRates[to.toLowerCase()] || 1;
            return fromRate / toRate;
        }
        
        const mathFormulas = {
            'luas lingkaran': 'Luas = œÄ √ó r¬≤',
            'keliling lingkaran': 'Keliling = 2 √ó œÄ √ó r',
            'luas persegi': 'Luas = sisi √ó sisi (s¬≤)',
            'keliling persegi': 'Keliling = 4 √ó sisi',
            'luas segitiga': 'Luas = ¬Ω √ó alas √ó tinggi',
            'volume kubus': 'Volume = sisi¬≥',
            'volume balok': 'Volume = panjang √ó lebar √ó tinggi',
            'pythagoras': 'c¬≤ = a¬≤ + b¬≤ (mencari sisi miring)',
            'rumus abc': 'x = [-b ¬± sqrt(b¬≤ - 4ac)] / 2a',
            'faktorial': 'n! = n √ó (n-1) √ó ... √ó 1',
            'permutasi': 'P(n, r) = n! / (n - r)!',
            'kombinasi': 'C(n, r) = n! / (r! √ó (n - r)!)',
        };

        // =================================================================
        // FUNGSI UTILITY DASAR & EKSEKUSI
        // =================================================================

        function cleanExpression(expression) {
            // Penggantian operator dasar
            let cleaned = expression
                .replace(/√∑/g, '/').replace(/√ó/g, '*')
                .replace(/MOD/g, '%').replace(/\^/g, '**')
                .replace(/%/g, '/100'); 
            
            // Penggantian fungsi Math JS
            cleaned = cleaned
                .replace(/sin\(/g, 'Math.sin(').replace(/cos\(/g, 'Math.cos(')
                .replace(/tan\(/g, 'Math.tan(').replace(/log\(/g, 'Math.log10(') 
                .replace(/ln\(/g, 'Math.log(').replace(/sqrt\(/g, 'Math.sqrt(')
                .replace(/pi/g, 'Math.PI').replace(/e/g, 'Math.E')
                .replace(/\*\*2/g, '**2'); 
            
            // Penanganan Faktorial, Permutasi, Kombinasi
            cleaned = cleaned.replace(/(\d+)\!/g, 'factorial($1)');
            cleaned = cleaned.replace(/perm\(([^,]+),\s*([^)]+)\)/g, 'permutation($1, $2)');
            cleaned = cleaned.replace(/comb\(([^,]+),\s*([^)]+)\)/g, 'combination($1, $2)');

            // Definisikan fungsi custom agar dieksekusi oleh 'new Function()'
            const functionDefinitions = `
                const factorial = ${factorial.toString()};
                const permutation = ${permutation.toString()};
                const combination = ${combination.toString()};
            `;
            
            return functionDefinitions + 'return ' + cleaned;
        }

        function updateDisplay() {
            resultEl.textContent = currentExpression;
            // Penyesuaian font dan arah untuk auto-scroll
            if (currentExpression.length > 15) {
                resultEl.style.fontSize = '2em';
                resultEl.style.direction = 'rtl';
                resultEl.style.textAlign = 'left';
            } else {
                resultEl.style.fontSize = '3.5em';
                resultEl.style.direction = 'ltr'; 
                resultEl.style.textAlign = 'right';
            }
            resultEl.scrollLeft = 0; // Kunci: scroll ke kanan penuh
        }

        function calculate() {
            let expressionToCalculate = currentExpression;
            if (expressionToCalculate === '0' || expressionToCalculate === 'Error') return;

            try {
                // Eksekusi kode dengan fungsi custom
                const executableCode = cleanExpression(expressionToCalculate);
                let calculatedResult = (new Function(executableCode))();
                
                if (!isFinite(calculatedResult)) throw new Error("Invalid Calculation");

                calculatedResult = parseFloat(calculatedResult.toFixed(10));
                let formattedResult = String(calculatedResult);
                addToHistory(expressionToCalculate, formattedResult, null, calculatedResult);

                historyCurrentEl.textContent = expressionToCalculate + ' =';
                lastResult = calculatedResult;
                currentExpression = formattedResult;
                
                updateDisplay();

            } catch (error) {
                historyCurrentEl.textContent = expressionToCalculate + ' =';
                currentExpression = 'Error';
                lastResult = null;
                updateDisplay();
                console.error("Calculation Error:", error);
            }
        }
        
        // ... (Fungsi Persistensi dan Handler Tombol dipersingkat di sini, tapi lengkap di kode)
        function loadHistory() {
            const storedHistory = localStorage.getItem('calculatorHistory');
            if (storedHistory) {
                try { historyRecords = JSON.parse(storedHistory); } catch (e) { historyRecords = []; }
            }
            renderHistory();
        }

        function saveHistory() {
            localStorage.setItem('calculatorHistory', JSON.stringify(historyRecords));
        }

        function addToHistory(expression, result, combination = null, originalResult = null) {
            if (expression !== 'Error' && expression !== '0') {
                const lastRecord = historyRecords[historyRecords.length - 1];
                if (lastRecord && lastRecord.expression === expression && lastRecord.result === result) return;
                historyRecords.push({ expression: expression, result: result, combination: combination, originalResult: originalResult || result });
                saveHistory(); 
                renderHistory();
            }
        }
        
        function previewCalculation() {
            let expressionToCalculate = currentExpression;
            if (expressionToCalculate === '0' || expressionToCalculate === 'Error' || /[+\-√ó√∑ MOD\^()]$/.test(expressionToCalculate.slice(-1))) {
                historyCurrentEl.textContent = expressionToCalculate === '0' || expressionToCalculate === 'Error' ? '' : expressionToCalculate + '...';
                return;
            }

            try {
                const executableCode = cleanExpression(expressionToCalculate);
                let calculatedResult = (new Function(executableCode))();
                
                if (!isFinite(calculatedResult)) { historyCurrentEl.textContent = 'Invalid Input'; return; }

                calculatedResult = parseFloat(calculatedResult.toFixed(10)); 
                let formattedResult = String(calculatedResult);
                historyCurrentEl.textContent = ' = ' + formattedResult;

            } catch (error) {
                historyCurrentEl.textContent = expressionToCalculate + '...'; 
            }
        }
        
        function handleButton(value) {
            if (value === 'clear') { currentExpression = '0'; historyCurrentEl.textContent = ''; lastResult = null; } 
            else if (value === '=') { calculate(); return; }
            else if (value === '%') { if (/[0-9)]$/.test(currentExpression.slice(-1))) { currentExpression += '%'; } else { return; } } 
            else if (value === '!') { if (/[0-9)]$/.test(currentExpression.slice(-1))) { currentExpression += '!'; } else { return; } }
            else if (value === 'backspace') {
                if (currentExpression === 'Error') { currentExpression = '0'; } 
                else if (lastResult !== null) { currentExpression = '0'; lastResult = null; } 
                else {
                    currentExpression = currentExpression.slice(0, -1);
                    if (currentExpression.endsWith(' MOD ')) { currentExpression = currentExpression.slice(0, -5); }
                    if (currentExpression.length === 0) { currentExpression = '0'; }
                }
            } 
            else if (value === '^2') {
                  if (/[0-9)]/.test(currentExpression.slice(-1))) { currentExpression += '^2'; }
                  else if (currentExpression === '0' && /[0-9)]/.test(currentExpression.slice(-1))) { currentExpression += '^2'; }
                  else if (currentExpression === '0') { return; }
                  else { currentExpression += '^2'; } 
            } 
            else if (value === 'perm(' || value === 'comb(') {
                // Untuk Permutasi/Kombinasi, tambahkan operator dan kurung buka
                if (currentExpression === '0' || lastResult !== null) { currentExpression = value; lastResult = null; }
                else { currentExpression += value; }
            }
            else {
                const isOperator = /[+\-√ó√∑ MOD()^%]/.test(value) || value.includes('(');
                if (lastResult !== null && lastResult !== undefined) {
                    if (isOperator) { currentExpression = String(lastResult) + value; } 
                    else { currentExpression = value; }
                    lastResult = null;
                    historyCurrentEl.textContent = '';
                } else {
                    if (currentExpression === '0' && value !== '.') { currentExpression = value; } 
                    else { currentExpression += value; }
                }
            }
            currentExpression = currentExpression.replace(/\*/g, '√ó').replace(/\//g, '√∑');
            updateDisplay();
            previewCalculation(); 
        }

        // =================================================================
        // LOGIKA RIWAYAT, KUNCI, DAN SUARA
        // =================================================================

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.onstart = () => { micBtn.innerHTML = '<span class="material-icons">mic</span> Mendengarkan...'; micBtn.classList.add('listening'); historyCurrentEl.textContent = 'Mendengarkan...'; };
            recognition.onend = () => { micBtn.innerHTML = '<span class="material-icons">mic</span>'; micBtn.classList.remove('listening'); };
            recognition.onresult = (event) => { processVoiceCommand(event.results[0][0].transcript.toLowerCase()); };
            recognition.onerror = (event) => { console.error("Kesalahan Pengenalan Suara:", event.error); micBtn.innerHTML = '<span class="material-icons">mic</span> Error'; micBtn.classList.remove('listening'); historyCurrentEl.textContent = 'Gagal merekam suara.'; };
            micBtn.addEventListener('click', () => { try { recognition.start(); } catch (e) { console.warn("Recognition already started or error in browser support.", e); } });
        } else { micBtn.style.display = 'none'; } 

        function processVoiceCommand(command) {
            historyCurrentEl.textContent = 'Perintah Suara: ' + command;
            let expression = command;
            
            // FASE 1: PENANGANAN PERINTAH KHUSUS (RUMUS, CLEAR)
            const formulaMatch = command.match(/rumus\s+(.+)/i);
            if (formulaMatch) {
                const query = formulaMatch[1].trim();
                const formula = mathFormulas[query];
                if (formula) {
                    currentExpression = '0';
                    historyCurrentEl.textContent = `Rumus ${query.toUpperCase()}: ${formula}`;
                } else {
                    historyCurrentEl.textContent = `Rumus '${query}' tidak ditemukan.`;
                }
                updateDisplay();
                return;
            }
            if (expression.includes('hapus') || expression.includes('clear')) { handleButton('clear'); return; }

            // FASE 2: Penggantian Kata Kunci Matematika ke Simbol/Fungsi
            expression = expression.replace(/akar kuadrat|akar/g, 'sqrt(')
                .replace(/pangkat/g, '^')
                .replace(/sinus/g, 'sin(').replace(/kosinus/g, 'cos(').replace(/tangen/g, 'tan(')
                .replace(/logaritma natural/g, 'ln(').replace(/logaritma/g, 'log(')
                .replace(/faktorial/g, '!') 
                .replace(/permutasi/g, 'perm').replace(/kombinasi/g, 'comb')
                .replace(/persen/g, '%')
                .replace(/tambah|plus/g, '+').replace(/kurang|minus|kurangi/g, '-')
                .replace(/kali|dikali|perkalian|x/g, '*').replace(/bagi|dibagi|per/g, '/')
                .replace(/modulus|modulo|sisa bagi/g, ' MOD ');
                
            // Penggantian Angka
            expression = expression.replace(/satu/g, '1').replace(/dua/g, '2').replace(/tiga/g, '3').replace(/empat/g, '4').replace(/lima/g, '5').replace(/enam/g, '6').replace(/tujuh/g, '7').replace(/delapan/g, '8').replace(/sembilan/g, '9').replace(/nol|kosong/g, '0').replace(/koma|titik/g, '.');

            
            // FASE 3: Logika Khusus (KONVERSI, GEOMETRI, PERSEN)
            
            // 1. KONVERSI MATA UANG
            const currencyMatch = command.match(/(\d+(\.\d+)?)\s*(usd|dolar|euro|eur|rupiah|idr|yen|jpy|aud)\s+(ke|jadi)\s*(usd|dolar|euro|eur|rupiah|idr|yen|jpy|aud)/i);
            if (currencyMatch) {
                const value = parseFloat(currencyMatch[1]);
                const fromCurrency = currencyMatch[3].replace(/dolar/i, 'usd').replace(/rupiah/i, 'idr');
                const toCurrency = currencyMatch[5].replace(/dolar/i, 'usd').replace(/rupiah/i, 'idr');

                const rate = getRate(fromCurrency, toCurrency);
                currentExpression = `${value}*${rate}`; 
                historyCurrentEl.textContent = `Konversi: ${value} ${fromCurrency.toUpperCase()} ke ${toCurrency.toUpperCase()} (Kurs Placeholder)`;
                updateDisplay(); calculate(); return;
            }

            // 2. PERHITUNGAN GEOMETRI (Volume & Luas)
            const volumeMatch = command.match(/panjang\s*(\d+(\.\d+)?)\s*kali\s*lebar\s*(\d+(\.\d+)?)\s*kali\s*tinggi\s*(\d+(\.\d+)?)/i);
            if (volumeMatch) {
                const p = volumeMatch[1]; const l = volumeMatch[3]; const t = volumeMatch[5];
                currentExpression = `${p}*${l}*${t}`; 
                historyCurrentEl.textContent = `Volume: ${p} √ó ${l} √ó ${t}`;
                updateDisplay(); calculate(); return;
            }
            const areaMatch = command.match(/panjang\s*(\d+(\.\d+)?)\s*kali\s*lebar\s*(\d+(\.\d+)?)/i);
            if (areaMatch) {
                const p = areaMatch[1]; const l = areaMatch[3];
                currentExpression = `${p}*${l}`; 
                historyCurrentEl.textContent = `Luas: ${p} √ó ${l}`;
                updateDisplay(); calculate(); return;
            }

            // 3. PERHITUNGAN PERSEN
            const percentOfMatch = command.match(/(\d+(\.\d+)?)\s*persen\s+dari\s*(\d+(\.\d+)?)/i); 
            if (percentOfMatch) {
                let percentValue = percentOfMatch[1]; let baseValue = percentOfMatch[3];
                currentExpression = `${percentValue}/100*${baseValue}`; 
                historyCurrentEl.textContent = `Persen: ${percentValue}% dari ${baseValue}`;
                updateDisplay(); calculate(); return;
            }
            const percentIsMatch = command.match(/(\d+(\.\d+)?)\s+dari\s*(\d+(\.\d+)?)\s*persen/i); 
            if (percentIsMatch) {
                let partValue = percentIsMatch[1]; let totalValue = percentIsMatch[3];
                currentExpression = `(${partValue}/${totalValue})*100`; 
                historyCurrentEl.textContent = `Rasio Persen: ${partValue} dari ${totalValue}`;
                updateDisplay(); calculate(); return;
            }

            // FASE 4: Eksekusi Ekspresi Fleksibel
            let cleanSpeech = expression.replace(/tolong hitung|hitung|adalah/g, '').trim();
            cleanSpeech = cleanSpeech
                .replace(/ ke /g, ' ').replace(/ jadi /g, ' ').replace(/ buat /g, ' ')
                .replace(/ banding /g, ' ').replace(/ per /g, ' ')
                .replace(/\s+/g, ''); 

            
            if (cleanSpeech.length > 0) {
                currentExpression = cleanSpeech.replace(/\*/g, '√ó').replace(/\//g, '√∑').replace(/\^/g, '^').replace(/MOD/g, ' MOD ');
                updateDisplay();
                calculate();
            }
        }


        // =================================================================
        // PANEL LOGIC (HISTORY & KEY)
        // =================================================================

        function togglePanel(panelEl, isOpen) {
            if (isOpen) { 
                panelEl.classList.add('open'); 
                overlay.classList.add('active'); 
                // Tutup panel lain jika membuka panel baru
                const otherPanel = (panelEl.id === 'historyPanel') ? keyPanel : historyPanel;
                if (otherPanel.classList.contains('open')) {
                    otherPanel.classList.remove('open');
                }
            } else { 
                panelEl.classList.remove('open'); 
                if (!historyPanel.classList.contains('open') && !keyPanel.classList.contains('open')) {
                    overlay.classList.remove('active');
                }
            }
        }

        burgerMenuBtn.addEventListener('click', () => {
            togglePanel(historyPanel, !historyPanel.classList.contains('open'));
        });
        keyBtn.addEventListener('click', () => {
            togglePanel(keyPanel, !keyPanel.classList.contains('open'));
        });
        closeKeyPanelBtn.addEventListener('click', () => { togglePanel(keyPanel, false); });
        overlay.addEventListener('click', () => { 
            togglePanel(historyPanel, false);
            togglePanel(keyPanel, false);
        });

        function renderHistory() {
            historyListEl.innerHTML = '';
            if (historyRecords.length === 0) { historyListEl.innerHTML = '<p class="empty-history">Belum ada perhitungan.</p>'; return; }
            historyRecords.slice().reverse().forEach((record) => {
                const item = document.createElement('div');
                item.classList.add('history-item');
                item.innerHTML = `<div class="history-expression">${record.expression} =</div><div class="history-result">${record.result}</div>`;
                item.addEventListener('click', () => {
                    currentExpression = String(record.result); 
                    historyCurrentEl.textContent = record.expression + ' =';
                    lastResult = parseFloat(record.originalResult);
                    updateDisplay();
                    togglePanel(historyPanel, false);
                });
                historyListEl.appendChild(item);
            });
        }

        clearHistoryBtn.addEventListener('click', () => {
            historyRecords = [];
            localStorage.removeItem('calculatorHistory'); 
            renderHistory();
        });

        // KONTEN HALAMAN KUNCI
        function renderKeyList() {
            const keys = [
                { title: 'Perhitungan Dasar', content: 'Gunakan **ke**, **jadi**, atau **buat** untuk menyambung ekspresi. Contoh: "lima puluh ke tiga kali dua".' },
                { title: 'Fungsi Expert & Ilmiah', content: 'sinus [A], kosinus [A], tangen [A], logaritma [A] ($\log_{10}$), **logaritma natural [A] ($\ln$)**, **[A] faktorial** ([A]!), **permutasi [n] koma [r]**, **kombinasi [n] koma [r]**.' },
                { title: 'Perhitungan Geometri', content: 'Luas: **panjang [A] kali lebar [B]**. Volume: **panjang [A] kali lebar [B] kali tinggi [C]**.' },
                { title: 'Konversi Mata Uang (Placeholder)', content: 'Gunakan **[nilai] [mata uang A] ke [mata uang B]**. Mata uang yang didukung: **dolar (USD), rupiah (IDR), euro (EUR), yen (JPY)**.' },
                { title: 'Perhitungan Persen', content: 'Nilai: **[X] persen dari [Y]**. Rasio: **[X] dari [Y] persen**.' },
                { title: 'Pencarian Rumus üìö', content: 'Katakan: **rumus [nama rumus]**. Contoh: "rumus volume balok", "rumus pythagoras", "rumus luas lingkaran".' },
                { title: 'Perintah Lain', content: '**hapus** atau **clear** untuk menghapus tampilan.' }
            ];

            keyListEl.innerHTML = '';
            keys.forEach(key => {
                const group = document.createElement('div');
                group.classList.add('key-group');
                group.innerHTML = `<h3>${key.title}</h3><p>${key.content.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>')}</p>`;
                keyListEl.appendChild(group);
            });
        }

        // =================================================================
        // INISIALISASI AKHIR
        // =================================================================

        buttons.addEventListener('click', (e) => {
            let target = e.target;
            if (!target.classList.contains('btn')) { target = target.closest('.btn'); }
            if (target) {
                const value = target.getAttribute('data-value');
                if (value === 'module') { handleButton(' MOD '); } else { handleButton(value); }
            }
        });

        loadHistory();
        renderKeyList(); 
        updateDisplay(); 
    </script>
</body>
</html>

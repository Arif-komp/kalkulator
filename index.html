<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Ilmiah AYIIPP</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --primary-color: #00bcd4; --primary-dark: #0097a7; --background-color: #eef1f5; --card-color: #ffffff; --text-color: #333; --operator-color: #ff9800; --scientific-color: #5c6bc0; --expert-color: #3f51b5; --history-bg: #f5f7fa; --calc-max-width: 400px; --padding-base: 20px; --history-width: 300px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .main-container { position: relative; width: 100%; max-width: var(--calc-max-width); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 5px rgba(0, 0, 0, 0.05); border-radius: 20px; overflow: hidden; }
        .calculator { background-color: var(--card-color); padding: var(--padding-base); }
        .display-container { text-align: right; margin-bottom: 20px; padding: 10px 5px; }
        .history-current { font-size: 1em; color: #888; min-height: 1.1em; line-height: 1.1em; }
        .result { font-size: 3.5em; font-weight: 300; color: var(--text-color); overflow-x: scroll; white-space: nowrap; line-height: 1.2; direction: rtl; text-align: left; }
        .result::-webkit-scrollbar { height: 6px; }
        .result::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .result::-webkit-scrollbar-track { background: transparent; }
        .buttons { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(9, 1fr); gap: 8px; }
        .btn { padding: 12px 0; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.05s, box-shadow 0.05s, transform 0.05s; font-weight: 500; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); min-height: 48px; }
        .btn:active { transform: translateY(0); box-shadow: 0 0 1px rgba(0, 0, 0, 0.1); filter: brightness(0.95); }
        .buttons button[data-value="0"] { grid-column: 2 / span 2; grid-row: 9; direction: ltr; } 
        .buttons button[data-value="."]{ grid-column: 1; grid-row: 9; direction: ltr;}
        .buttons button[data-value="="] { grid-column: 4; grid-row: 9; direction: ltr;}
        .num { background-color: #f0f0f0; color: var(--text-color); } 
        .op, .eq { background-color: var(--operator-color); color: white; font-weight: bold; } 
        .fn { background-color: #e0f7fa; color: var(--primary-dark); font-weight: 600; font-size: 1em; } 
        .sci { background-color: var(--scientific-color); color: white; font-size: 0.9em; font-weight: 500; box-shadow: 0 1px 3px rgba(92, 107, 192, 0.3); } 
        .expert { background-color: var(--expert-color); color: white; font-size: 0.9em; } 
        .eq { background-color: var(--primary-color); font-size: 1.4em; } 
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px; }
        .header > div { display: flex; gap: 10px; } 
        .burger-menu, .mic-button { background: none; border: none; cursor: pointer; color: var(--primary-dark); padding: 5px; z-index: 1001; transition: color 0.2s; }
        .mic-button span.material-icons { font-size: 1.6em; }
        .title { color: var(--primary-color); font-size: 1.8em; font-weight: 800; letter-spacing: 2px; margin: 0; }
        
        /* Riwayat Panel */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .overlay.active { opacity: 1; visibility: visible; }
        .history-panel { 
            position: fixed; top: 0; left: 0; 
            width: var(--history-width); max-width: 80%; 
            height: 100%; 
            background: var(--history-bg); 
            z-index: 1000; 
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1); 
            transform: translateX(-100%); 
            transition: transform 0.3s; 
            display: flex; flex-direction: column; 
        }
        .history-panel.open { transform: translateX(0); }
        
        .history-header { padding: var(--padding-base); background-color: var(--card-color); border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .history-header h2 { margin: 0; font-size: 1.2em; color: var(--text-color); }
        .history-header button { background: none; border: none; cursor: pointer; color: #f44336; padding: 5px; }
        .history-list { padding: 0; flex-grow: 1; overflow-y: auto; } 
        
        /* RIWAYAT BARU YANG RAPI */
        .history-item { 
            padding: 15px var(--padding-base); 
            border-bottom: 1px solid #ddd;
            cursor: pointer; 
            transition: background 0.2s; 
        }
        .history-item:hover { background: #e6e9ee; }
        .history-item:last-child { border-bottom: none; }
        .history-expression { 
            font-size: 0.9em; 
            color: #777; 
            overflow-wrap: break-word; 
            direction: ltr;
            text-align: right;
            min-height: 1.2em;
        }
        .history-result { 
            font-size: 1.5em; 
            font-weight: 500; 
            color: var(--text-color); 
            margin-top: 2px;
            direction: ltr;
            text-align: right;
        }
        .empty-history { color: #999; text-align: center; padding: 20px; } 
        
        @media (max-width: 550px) {
            body { align-items: flex-start; }
            .main-container { border-radius: 0; box-shadow: none; min-height: 100vh; max-width: none; }
            .calculator { padding: 15px; }
            .buttons { gap: 6px; } 
            .btn { min-height: 45px; } 
            .history-item { padding: 15px 15px; } 
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div> 
    
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h2>Riwayat Perhitungan ðŸ§¾</h2>
            <div>
                <button id="clearHistoryBtn" title="Hapus Semua Riwayat">
                    <span class="material-icons">delete</span>
                </button>
                <button id="closeHistoryPanelBtn" title="Tutup">
                    <span class="material-icons">close</span>
                </button>
            </div>
        </div>
        <div id="historyList" class="history-list">
            <p class="empty-history">Belum ada perhitungan.</p>
        </div>
    </div>
    
    <div class="main-container">
        <div class="calculator">
            
            <div class="header">
                <button class="burger-menu" id="burgerMenu" title="Riwayat">
                    <span class="material-icons">history</span>
                </button>
                <h1 class="title">Ayiipp</h1>
                <div>
                    <button id="micBtn" class="mic-button" title="Input Suara">
                        <span class="material-icons">mic</span>
                    </button>
                </div>
            </div>
            
            <div class="display-container">
                <div id="history-current" class="history-current"></div>
                <div id="result" class="result">0</div> 
            </div>
            
            <div class="buttons">
                
                <button class="btn expert" data-value="ln(">ln</button>
                <button class="btn expert" data-value="!">n!</button>
                <button class="btn expert" data-value="perm(" title="Permutasi: n, r">P(n,r)</button>
                <button class="btn expert" data-value="comb(" title="Kombinasi: n, r">C(n,r)</button>

                <button class="btn sci" data-value="sin(">sin</button>
                <button class="btn sci" data-value="cos(">cos</button>
                <button class="btn sci" data-value="tan(">tan</button>
                <button class="btn sci" data-value="^">xÊ¸</button>

                <button class="btn sci" data-value="log(">log</button>
                <button class="btn sci" data-value="pi">Ï€</button>
                <button class="btn sci" data-value="e">e</button>
                <button class="btn sci" data-value="sqrt(">âˆš</button>

                <button class="btn fn" data-value="clear">C</button>
                <button class="btn fn" data-value="%">%</button>
                <button class="btn fn" data-value="module">MOD</button>
                <button class="btn sci" data-value="^2">xÂ²</button>

                <button class="btn op" data-value="(">(</button>
                <button class="btn op" data-value=")">)</button>
                <button class="btn fn" data-value="backspace"><span class="material-icons">backspace</span></button>
                <button class="btn op" data-value="/">Ã·</button>

                <button class="btn num" data-value="7">7</button>
                <button class="btn num" data-value="8">8</button>
                <button class="btn num" data-value="9">9</button>
                <button class="btn op" data-value="*">Ã—</button>

                <button class="btn num" data-value="4">4</button>
                <button class="btn num" data-value="5">5</button>
                <button class="btn num" data-value="6">6</button>
                <button class="btn op" data-value="-">-</button>

                <button class="btn num" data-value="1">1</button>
                <button class="btn num" data-value="2">2</button>
                <button class="btn num" data-value="3">3</button>
                <button class="btn op" data-value="+">+</button>

                <button class="btn num" data-value=".">.</button>
                <button class="btn num" data-value="0">0</button>
                <button class="btn eq" data-value="=">=</button>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const resultEl = document.getElementById('result');
        const historyCurrentEl = document.getElementById('history-current');
        const historyListEl = document.getElementById('historyList'); 
        const micBtn = document.getElementById('micBtn');
        const buttons = document.querySelector('.buttons');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const burgerMenuBtn = document.getElementById('burgerMenu');
        const historyPanel = document.getElementById('historyPanel'); 
        const overlay = document.getElementById('overlay');
        const closeHistoryPanelBtn = document.getElementById('closeHistoryPanelBtn');


        // Variabel Status Global
        let currentExpression = '0';
        let lastResult = null;
        let historyRecords = []; 

        // --- FUNGSI MATEMATIKA EXPERT ---
        function factorial(n) {
            if (n < 0 || n % 1 !== 0) throw new Error("Faktorial hanya untuk bilangan bulat non-negatif.");
            if (n === 0) return 1;
            let res = 1;
            for (let i = 2; i <= n; i++) res *= i;
            return res;
        }
        function permutation(n, r) {
            if (n < r || n < 0 || r < 0) return NaN;
            return factorial(n) / factorial(n - r);
        }
        function combination(n, r) {
            if (n < r || n < 0 || r < 0) return NaN;
            return factorial(n) / (factorial(r) * factorial(n - r));
        }

        // --- DATA DUMMY UNTUK KONVERSI DAN RUMUS ---
        const currencyRates = { usd: 15000, idr: 1, eur: 16000, jpy: 105, aud: 10000 };
        function getRate(from, to) {
            const fromRate = currencyRates[from.toLowerCase()] || 1;
            const toRate = currencyRates[to.toLowerCase()] || 1;
            return fromRate / toRate;
        }
        const mathFormulas = {
            'luas lingkaran': 'Luas = Ï€ Ã— rÂ²', 'keliling lingkaran': 'Keliling = 2 Ã— Ï€ Ã— r',
            'luas persegi': 'Luas = sisi Ã— sisi (sÂ²)', 'volume balok': 'Volume = panjang Ã— lebar Ã— tinggi',
            'faktorial': 'n! = n Ã— (n-1) Ã— ... Ã— 1',
        };

        // --- FUNGSI UTILITY DASAR & EKSEKUSI ---
        function cleanExpression(expression) {
            let cleaned = expression.replace(/Ã·/g, '/').replace(/Ã—/g, '*').replace(/MOD/g, '%').replace(/\^/g, '**').replace(/%/g, '/100'); 
            cleaned = cleaned.replace(/sin\(/g, 'Math.sin(').replace(/cos\(/g, 'Math.cos(').replace(/tan\(/g, 'Math.tan(').replace(/log\(/g, 'Math.log10(').replace(/ln\(/g, 'Math.log(').replace(/sqrt\(/g, 'Math.sqrt(').replace(/pi/g, 'Math.PI').replace(/e/g, 'Math.E').replace(/\*\*2/g, '**2'); 
            cleaned = cleaned.replace(/(\d+)\!/g, 'factorial($1)').replace(/perm\(([^,]+),\s*([^)]+)\)/g, 'permutation($1, $2)').replace(/comb\(([^,]+),\s*([^)]+)\)/g, 'combination($1, $2)');
            const functionDefinitions = `const factorial = ${factorial.toString()}; const permutation = ${permutation.toString()}; const combination = ${combination.toString()};`;
            return functionDefinitions + 'return ' + cleaned;
        }
        function updateDisplay() {
            resultEl.textContent = currentExpression;
            if (currentExpression.length > 15) {
                resultEl.style.fontSize = '2em'; resultEl.style.direction = 'rtl'; resultEl.style.textAlign = 'left';
            } else {
                resultEl.style.fontSize = '3.5em'; resultEl.style.direction = 'ltr'; resultEl.style.textAlign = 'right';
            }
            resultEl.scrollLeft = 0; 
        }
        
        function calculate() {
            let expressionToCalculate = currentExpression;
            if (expressionToCalculate === '0' || expressionToCalculate === 'Error') return;

            try {
                const executableCode = cleanExpression(expressionToCalculate);
                let calculatedResult = (new Function(executableCode))();
                
                if (!isFinite(calculatedResult)) throw new Error("Invalid Calculation");

                calculatedResult = parseFloat(calculatedResult.toFixed(10)); 

                let formattedResult = String(calculatedResult);
                
                // Simpan ekspresi lengkap untuk riwayat (Perhitungan Biasa)
                addToHistory(expressionToCalculate, formattedResult, null, calculatedResult); 

                historyCurrentEl.textContent = expressionToCalculate + ' =';
                lastResult = calculatedResult;
                currentExpression = formattedResult;
                
                updateDisplay();

            } catch (error) {
                historyCurrentEl.textContent = expressionToCalculate + ' =';
                currentExpression = 'Error';
                lastResult = null;
                updateDisplay();
                console.error("Calculation Error:", error);
            }
        }
        
        function loadHistory() {
            const storedHistory = localStorage.getItem('calculatorHistory');
            if (storedHistory) { 
                try { 
                    historyRecords = JSON.parse(storedHistory); 
                } catch (e) { 
                    console.error("Gagal memuat riwayat:", e);
                    historyRecords = []; 
                } 
            }
            renderHistory();
        }

        function saveHistory() { localStorage.setItem('calculatorHistory', JSON.stringify(historyRecords)); }
        
        function addToHistory(expression, result, combination = null, originalResult = null) {
            if (expression !== 'Error' && expression !== '0') {
                const lastRecord = historyRecords[historyRecords.length - 1];
                // Jangan simpan jika hasil & ekspresi sama persis dengan yang terakhir (Hanya untuk hitungan biasa)
                if (!combination && lastRecord && lastRecord.expression === expression && lastRecord.result === result) return;
                
                historyRecords.push({ expression: expression, result: result, combination: combination, originalResult: originalResult || result });
                saveHistory(); 
                renderHistory(); 
            }
        }
        function previewCalculation() {
            let expressionToCalculate = currentExpression;
            if (expressionToCalculate === '0' || expressionToCalculate === 'Error' || /[+\-Ã—Ã· MOD\^()]$/.test(expressionToCalculate.slice(-1))) {
                historyCurrentEl.textContent = expressionToCalculate === '0' || expressionToCalculate === 'Error' ? '' : expressionToCalculate + '...';
                return;
            }
            try {
                const executableCode = cleanExpression(expressionToCalculate);
                let calculatedResult = (new Function(executableCode))();
                if (!isFinite(calculatedResult)) { historyCurrentEl.textContent = 'Invalid Input'; return; }
                calculatedResult = parseFloat(calculatedResult.toFixed(10)); 
                let formattedResult = String(calculatedResult);
                historyCurrentEl.textContent = ' = ' + formattedResult;
            } catch (error) {
                historyCurrentEl.textContent = expressionToCalculate + '...'; 
            }
        }
        function handleButton(value) {
            if (value === 'clear') { currentExpression = '0'; historyCurrentEl.textContent = ''; lastResult = null; } 
            else if (value === '=') { calculate(); return; }
            else if (value === '%') { if (/[0-9)]$/.test(currentExpression.slice(-1))) { currentExpression += '%'; } else { return; } } 
            else if (value === '!') { if (/[0-9)]$/.test(currentExpression.slice(-1))) { currentExpression += '!'; } else { return; } }
            else if (value === 'backspace') {
                if (currentExpression === 'Error') { currentExpression = '0'; } 
                else if (lastResult !== null) { currentExpression = '0'; lastResult = null; } 
                else {
                    currentExpression = currentExpression.slice(0, -1);
                    if (currentExpression.endsWith(' MOD ')) { currentExpression = currentExpression.slice(0, -5); }
                    if (currentExpression.length === 0) { currentExpression = '0'; }
                }
            } 
            else if (value === '^2') {
                  if (/[0-9)]/.test(currentExpression.slice(-1))) { currentExpression += '^2'; }
                  else if (currentExpression === '0' && /[0-9)]/.test(currentExpression.slice(-1))) { currentExpression += '^2'; }
                  else if (currentExpression === '0') { return; }
                  else { currentExpression += '^2'; } 
            } 
            else if (value === 'perm(' || value === 'comb(') {
                if (currentExpression === '0' || lastResult !== null) { currentExpression = value; lastResult = null; }
                else { currentExpression += value; }
            }
            else {
                const isOperator = /[+\-Ã—Ã· MOD()^%]/.test(value) || value.includes('(');
                if (lastResult !== null && lastResult !== undefined) {
                    if (isOperator) { currentExpression = String(lastResult) + value; } 
                    else { currentExpression = value; }
                    lastResult = null;
                    historyCurrentEl.textContent = '';
                } else {
                    if (currentExpression === '0' && value !== '.') { currentExpression = value; } 
                    else { currentExpression += value; }
                }
            }
            currentExpression = currentExpression.replace(/\*/g, 'Ã—').replace(/\//g, 'Ã·');
            updateDisplay();
            previewCalculation(); 
        }

        // =================================================================
        // LOGIKA SUARA
        // =================================================================

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.onstart = () => { micBtn.innerHTML = '<span class="material-icons">mic</span> Mendengarkan...'; micBtn.classList.add('listening'); historyCurrentEl.textContent = 'Mendengarkan...'; };
            recognition.onend = () => { micBtn.innerHTML = '<span class="material-icons">mic</span>'; micBtn.classList.remove('listening'); };
            recognition.onresult = (event) => { processVoiceCommand(event.results[0][0].transcript.toLowerCase()); };
            recognition.onerror = (event) => { console.error("Kesalahan Pengenalan Suara:", event.error); micBtn.innerHTML = '<span class="material-icons">mic</span> Error'; micBtn.classList.remove('listening'); historyCurrentEl.textContent = 'Gagal merekam suara.'; };
            micBtn.addEventListener('click', () => { try { recognition.start(); } catch (e) { console.warn("Recognition already started or error in browser support.", e); } });
        } else { micBtn.style.display = 'none'; } 

        function processVoiceCommand(command) {
            historyCurrentEl.textContent = 'Perintah Suara: ' + command;
            let expression = command;
            
            // FASE 1: PENANGANAN PERINTAH KHUSUS (RUMUS, CLEAR)
            const formulaMatch = command.match(/rumus\s+(.+)/i);
            if (formulaMatch) {
                const query = formulaMatch[1].trim();
                const formula = mathFormulas[query];
                if (formula) {
                    currentExpression = '0';
                    historyCurrentEl.textContent = `Rumus ${query.toUpperCase()}: ${formula}`;
                } else {
                    historyCurrentEl.textContent = `Rumus '${query}' tidak ditemukan.`;
                }
                updateDisplay();
                return;
            }
            if (expression.includes('hapus') || expression.includes('clear')) { handleButton('clear'); return; }

            // FASE 2: Penggantian Kata Kunci Matematika ke Simbol/Fungsi
            expression = expression.replace(/akar kuadrat|akar/g, 'sqrt(')
                .replace(/pangkat/g, '^')
                .replace(/sinus/g, 'sin(').replace(/kosinus/g, 'cos(').replace(/tangen/g, 'tan(')
                .replace(/logaritma natural/g, 'ln(').replace(/logaritma/g, 'log(')
                .replace(/faktorial/g, '!') 
                .replace(/permutasi/g, 'perm').replace(/kombinasi/g, 'comb')
                .replace(/persen/g, '%')
                .replace(/tambah|plus/g, '+').replace(/kurang|minus|kurangi/g, '-')
                .replace(/kali|dikali|perkalian|x/g, '*').replace(/bagi|dibagi|per/g, '/')
                .replace(/modulus|modulo|sisa bagi/g, ' MOD ')
                .replace(/jadi|ke|buat/g, ' '); 
                
            expression = expression
                .replace(/dolar|us dollar/g, 'usd').replace(/rupiah|rp/g, 'idr').replace(/euro/g, 'eur').replace(/yen|jpy/g, 'jpy')
                .replace(/satu/g, '1').replace(/dua/g, '2').replace(/tiga/g, '3').replace(/empat/g, '4').replace(/lima/g, '5').replace(/enam/g, '6').replace(/tujuh/g, '7').replace(/delapan/g, '8').replace(/sembilan/g, '9').replace(/nol|kosong/g, '0').replace(/koma|titik/g, '.');

            
            // FASE 3: Logika Khusus (Pencarian Variabel Implisit / Solver)
            const implicitMatch = expression.match(/^(\d+(\.\d+)?)\s+(\d+(\.\d+)?)\s*(.*)/);
            if (implicitMatch) {
                const valA = parseFloat(implicitMatch[1]); 
                const valB = parseFloat(implicitMatch[3]); 
                let remainingOp = implicitMatch[5] || ''; 
                // const originalVoiceTarget = valB + remainingOp; // Tidak dipakai

                if (!isNaN(valA) && !isNaN(valB) && valA !== 0) {
                    
                    remainingOp = remainingOp.trim()
                        .replace(/tambah|plus/g, '+').replace(/kurang|minus|kurangi/g, '-')
                        .replace(/kali|dikali|perkalian|x/g, '*').replace(/bagi|dibagi|per/g, '/')
                        .replace(/\s*([\+\-\*\/%MOD\^])\s*/g, '$1') 
                        .replace(/[\+\-\*\/%MOD\^]$/, '') 
                        .replace(/\s+/g, ''); 

                    const targetExpression = valB + (remainingOp || ''); 
                    let targetValue;

                    try {
                        const tempExecutableCode = cleanExpression(targetExpression.replace(/[A-Za-z]+\(|!/g, ''));
                        targetValue = (new Function(tempExecutableCode))();
                        targetValue = parseFloat(targetValue.toFixed(10));
                    } catch (e) {
                        historyCurrentEl.textContent = `Error: Ekspresi target akhir tidak valid (${targetExpression})`;
                        currentExpression = 'Error'; updateDisplay(); return;
                    }

                    if (isNaN(targetValue) || !isFinite(targetValue)) {
                        historyCurrentEl.textContent = `Error: Target akhir tidak valid (${targetExpression})`;
                        currentExpression = 'Error'; updateDisplay(); return;
                    }
                    
                    const factorX = Math.floor(targetValue / valA); 
                    const remainder = parseFloat((targetValue - (valA * factorX)).toFixed(10)); 
                    
                    let resultExpression; // Ekspresi langkah lengkap yang diminta (cth: 15 Ã— 33 + 5)
                    let finalCalculation; // Hasil akhir (cth: 500)
                    
                    if (remainder === 0) {
                        resultExpression = `${valA} Ã— ${factorX}`;
                        finalCalculation = `${valA * factorX}`;
                    } else if (remainder > 0) {
                        resultExpression = `${valA} Ã— ${factorX} + ${remainder}`;
                        finalCalculation = `${valA * factorX + remainder}`;
                    } else { 
                        // Jika remainder negatif, hitung dari pembulatan ke atas untuk tampilan pengurangan yang rapi
                        const factorX_ceil = Math.ceil(targetValue / valA);
                        const difference = Math.abs(parseFloat((factorX_ceil * valA - targetValue).toFixed(10)));
                        
                        // Gunakan pengurangan jika selisihnya lebih kecil atau hasilnya bilangan bulat
                        if (targetValue % valA === 0 || difference < Math.abs(remainder)) {
                           resultExpression = `${valA} Ã— ${factorX_ceil} - ${difference}`;
                        } else {
                           // Jika mendekati dari bawah (faktorX) dan lebih baik
                           resultExpression = `${valA} Ã— ${factorX} + ${remainder}`;
                        }
                        
                        finalCalculation = `${targetValue}`;
                    }
                    
                    // Ganti * menjadi Ã— untuk tampilan yang cantik
                    resultExpression = resultExpression.replace(/\*/g, 'Ã—');

                    currentExpression = String(targetValue); 
                    
                    // Display di history-current (Layar Utama) tetap berupa pertanyaan agar pengguna tahu apa yang dihitung
                    const historyQuestion = `${valA} di apakan agar bisa mendapatkan ${targetValue}?`;
                    historyCurrentEl.textContent = historyQuestion;
                    
                    lastResult = parseFloat(finalCalculation); 
                    updateDisplay(); 
                    
                    // SIMPAN RIWAYAT (PERUBAHAN UTAMA UNTUK HISTORY PANEL)
                    // Baris Atas History Panel: Langkah Lengkap (resultExpression)
                    // Baris Bawah History Panel: Hasil Akhir (finalCalculation)
                    addToHistory(
                        resultExpression, // Baris Atas History Panel (15 x 33 + 5)
                        String(targetValue), // Baris Bawah History Panel (500)
                        { 
                            question: historyQuestion, // Simpan pertanyaan untuk dimuat kembali
                            target: targetValue,
                        }, 
                        String(targetValue) // Nilai akhir 
                    ); 
                    return; 
                }
            }
            
            // FASE 4: Eksekusi Ekspresi Fleksibel (Operasi Biasa)
            let finalExpression = expression.replace(/tolong hitung|hitung|adalah/g, '').trim();

            finalExpression = finalExpression
                .replace(/perm\s+(\d+)\s+(\d+)/g, 'perm($1,$2)')
                .replace(/comb\s+(\d+)\s+(\d+)/g, 'comb($1,$2)');

            finalExpression = finalExpression
                .replace(/\s*([\+\-\*\/%MOD\^])\s*/g, '$1') 
                .replace(/[\+\-\*\/%MOD\^]$/, '') 
                .replace(/\s+/g, ''); 

            if (finalExpression.length > 0) {
                currentExpression = finalExpression.replace(/\*/g, 'Ã—').replace(/\//g, 'Ã·').replace(/\^/g, '^').replace(/MOD/g, ' MOD ');
                updateDisplay();
                calculate();
            }
        }

        // --- PANEL LOGIC ---

        function toggleHistoryPanel(isOpen) {
            if (isOpen) { 
                historyPanel.classList.add('open'); 
                overlay.classList.add('active'); 
            } else { 
                historyPanel.classList.remove('open'); 
                overlay.classList.remove('active');
            }
        }
        
        burgerMenuBtn.addEventListener('click', () => { toggleHistoryPanel(true); });
        closeHistoryPanelBtn.addEventListener('click', () => { toggleHistoryPanel(false); });
        overlay.addEventListener('click', () => { toggleHistoryPanel(false); });

        // FUNGSI UTAMA DISPLAY RIWAYAT
        function renderHistory() {
            historyListEl.innerHTML = ''; 
            if (historyRecords.length === 0) { historyListEl.innerHTML = '<p class="empty-history">Belum ada perhitungan.</p>'; return; }
            
            historyRecords.slice().reverse().forEach((record) => {
                const item = document.createElement('div');
                item.classList.add('history-item');
                
                let expressionText = record.expression;
                let resultText = record.result;
                
                if (record.combination) {
                    // JIKA SOLVER (PERMINTAAN TERAKHIR ANDA):
                    // Baris Atas: Langkah Lengkap (15 Ã— 33 + 5)
                    // Baris Bawah: Hasil Akhir (500)
                    expressionText = record.expression; 
                    resultText = record.result; 
                } else {
                    // JIKA PERHITUNGAN BIASA (Standar):
                    // Baris Atas: Ekspresi Awal (100 Ã— sin(30))
                    // Baris Bawah: Hasil Akhir (50)
                    expressionText = record.expression; 
                    resultText = record.result;
                }

                item.innerHTML = `<div class="history-expression">${expressionText} =</div><div class="history-result">${resultText}</div>`;
                
                item.addEventListener('click', () => {
                    if (record.combination) { 
                        // Muat hasil akhirnya (500) dan tampilkan pertanyaan aslinya di preview
                        currentExpression = String(record.originalResult); 
                        historyCurrentEl.textContent = record.combination.question; 
                    } else { 
                        // Muat hasil akhirnya (50) dan tampilkan ekspresi di preview
                        currentExpression = String(record.originalResult); 
                        historyCurrentEl.textContent = record.expression + ' ='; 
                    }
                    lastResult = parseFloat(record.originalResult);
                    updateDisplay();
                    toggleHistoryPanel(false);
                });
                historyListEl.appendChild(item);
            });
        }
        
        clearHistoryBtn.addEventListener('click', () => {
            historyRecords = [];
            localStorage.removeItem('calculatorHistory'); 
            renderHistory(); 
        });

        // --- INISIALISASI AKHIR ---
        buttons.addEventListener('click', (e) => {
            let target = e.target;
            if (!target.classList.contains('btn')) { target = target.closest('.btn'); }
            if (target) {
                const value = target.getAttribute('data-value');
                if (value === 'module') { handleButton(' MOD '); } else { handleButton(value); }
            }
        });

        loadHistory(); 
        updateDisplay(); 
    </script>
</body>
</html>
